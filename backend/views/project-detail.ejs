<!-- views/project-detail.ejs -->
<%- include('partials/header') %>

    <div class="container" id="project-detail-container">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2">Carregando detalhes do projeto...</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const projectId = '<%= projectId %>';
            const container = document.getElementById('project-detail-container');

            try {
                const response = await fetch(`/api/projects/${projectId}`);
                const project = await response.json();

                if (!response.ok) {
                    throw new Error(project.msg || 'Erro ao carregar projeto');
                }

                // Calcular porcentagem de financiamento
                const fundingPercentage = ((project.currentFunding / project.fundingGoal) * 100).toFixed(1);

                // Formatar data de criação
                const createdDate = new Date(project.createdAt).toLocaleDateString('pt-BR');

                // Montar as recompensas
                let rewardsHtml = '';
                if (project.rewards && project.rewards.length > 0) {
                    rewardsHtml = `
                    <h5 class="mt-4">Recompensas</h5>
                    <ul class="list-group">
                        ${project.rewards.map(reward => `<li class="list-group-item">${reward}</li>`).join('')}
                    </ul>
                `;
                } else {
                    rewardsHtml = '<p class="text-muted">Nenhuma recompensa definida para este projeto.</p>';
                }

                // Renderizar o conteúdo
                container.innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-8">
                        <h1 class="display-5">${project.title}</h1>
                        <div class="d-flex align-items-center mb-3">
                            <span class="badge bg-primary me-2">${project.category}</span>
                            <span class="badge bg-secondary">${project.status}</span>
                        </div>
                        <p class="fs-5">${project.description}</p>
                        
                        <div class="card mt-4">
                            <div class="card-body">
                                <h5>Financiamento</h5>
                                <div class="progress mb-3">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: ${fundingPercentage}%" 
                                        aria-valuenow="${fundingPercentage}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <p class="mb-0">R$ ${project.currentFunding.toLocaleString('pt-BR')}</p>
                                    <p class="mb-0 text-muted">${fundingPercentage}%</p>
                                    <p class="mb-0">Meta: R$ ${project.fundingGoal.toLocaleString('pt-BR')}</p>
                                </div>
                                
                                ${project.creator && project.creator.role === 'investor' ? '' : `
                                <div class="d-grid mt-3">
                                    <button class="btn btn-success" id="support-project-btn">Apoiar este projeto</button>
                                </div>
                                `}
                            </div>
                        </div>
                        
                        ${rewardsHtml}
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h5>Criador</h5>
                                <div class="d-flex align-items-center">
                                    <div class="user-avatar me-3">
                                        <i class="fas fa-user-circle fa-3x text-primary"></i>
                                    </div>
                                    <div>
                                        <h6>${project.creator ? project.creator.name : 'Nome não disponível'}</h6>
                                        <p class="mb-0 text-muted">${project.creator ? (project.creator.role === 'developer' ? 'Desenvolvedor' : 'Investidor') : ''}</p>
                                    </div>
                                </div>
                                
                                <hr>
                                <div class="mb-2">
                                    <i class="fas fa-calendar-alt me-2"></i> Criado em: ${createdDate}
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5 class="mb-0">Compartilhar</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-around">
                                    <a href="#" class="text-primary fs-4"><i class="fab fa-facebook"></i></a>
                                    <a href="#" class="text-info fs-4"><i class="fab fa-twitter"></i></a>
                                    <a href="#" class="text-success fs-4"><i class="fab fa-whatsapp"></i></a>
                                    <a href="#" class="text-dark fs-4"><i class="fas fa-link"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

                // Adicionar evento ao botão de apoiar
                const supportBtn = document.getElementById('support-project-btn');
                if (supportBtn) {
                    supportBtn.addEventListener('click', function () {
                        alert('Funcionalidade de apoio a projetos será implementada em breve!');
                    });
                }

            } catch (error) {
                console.error('Erro:', error);
                container.innerHTML = `
                <div class="alert alert-danger">
                    <h4>Erro ao carregar projeto</h4>
                    <p>${error.message || 'Não foi possível carregar os detalhes deste projeto.'}</p>
                    <a href="/projects" class="btn btn-primary">Voltar para lista de projetos</a>
                </div>
            `;
            }
        });
    </script>

    <%- include('partials/footer') %>